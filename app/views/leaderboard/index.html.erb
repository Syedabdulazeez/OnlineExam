<div class="container">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <%= link_to "Dash Board", root_path, class: "nav-link" %>
        </li>
        <li class="nav-item">
          <%= link_to "Registrations", registrations_path, class: "nav-link" %>
        </li>
        <li class="nav-item">
          <a class="navbar-brand" href="#">Leader Board</a>
        </li>
      </ul>
      <ul class="navbar-nav">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Profile
          </a>
          <div class="dropdown-menu" aria-labelledby="userDropdown">
            <%= link_to "Profile", user_path(current_user), class: "dropdown-item" %>
            <%= link_to "Log Out", logout_path, class: "dropdown-item" %>
          </div>
        </li>
      </ul>
    </div>
  </nav>

  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card bg-light">
        <div class="card-body">
          <h2 class="card-title">Your Rank</h2>
          <div class="row">
            <div class="col">
              <% if @user.college.present? %>
                <% if @college_rank %>
                  <p class="card-text">College Rank: <%= @college_rank + 1 %></p>
                <% end %>
              <% else %>
                <p class="card-text">Update your profile to get college-wise rank</p>
              <% end %>
            </div>
            <div class="col">
              <% if @overall_rank %>
                <p class="card-text">Overall Rank: <%= @overall_rank + 1 %></p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-5">
    <div class="col-md-6">
      <h2>Your Exam-wise Performance</h2>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Exam</th>
            <th>Your Marks</th>
            <th>Average Marks</th>
            <th>Highest Marks</th>
            <th>Generate Report</th>
            <th>Chart</th>
          </tr>
        </thead>
        <tbody>
          <% if notice %>
            <tr>
              <div class="notice text-success">
                <%= notice %>
              </div>
            </tr>
          <% end %>
          <% @exam_averages.each do |exam_id, average_marks| %>
            <% exam = Exam.find_by(id: exam_id) %>
            <% performance = @exam_performances.find_by(exam_id: exam_id, user_id: current_user) %>
            <% highest_marks = @highest_marks[exam_id] %>
            <% user_performance = @exam_performances.find_by(exam_id: exam_id, user_id: current_user.id) %>
            <tr>
              <td><%= exam ? exam.exam_name : 'Exam not found' %></td>
              <td><%= user_performance ? user_performance.marks_obtained : 'N/A' %></td>
              <td><%= average_marks %></td>
              <td><%= highest_marks %></td>
              <td><%= link_to "Generate Performance Report", generate_report_path(performance.id), class: "" if performance %></td>
              <td>
                <% if exam && user_performance %>
                  <%= column_chart [
                  ['Average Mark', average_marks],
                  ['Highest Mark', highest_marks],
                  ['Your Mark', user_performance.marks_obtained]
                  ], library: { responsive: true } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row mt-5">
    <div class="col-md-6">
      <h2>Your Subject-wise Performance</h2>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Performance ID</th>
            <th>Subject</th>
            <th>Average Score</th>
          </tr>
        </thead>
        <tbody>
          <% @subject_performances.each do |performance_id, average_score| %>
            <tr>
              <td><%= performance_id %></td>
              <% subject = Subject.find_by(id: performance_id) %>
              <td><%= subject ? subject.subject_name : 'Subject not found' %></td>
              <td><%= average_score %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="col-md-6">
      <h2>Your Subject-wise Performance Chart</h2>
      <%= pie_chart @subject_performance_hash %>
    </div>
  </div>

  <div class="row mt-5">
    <div class="col-md-6">
      <h2>Your Department-wise Performance</h2>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Performance ID</th>
            <th>Department</th>
            <th>Average Score</th>
          </tr>
        </thead>
        <tbody>
          <% @department_performances.each do |performance_id, average_score| %>
            <tr>
              <td><%= performance_id %></td>
              <% department = Department.find_by(id: performance_id) %>
              <td><%= department ? department.department_name : 'Department not found' %></td>
              <td><%= average_score %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="col-md-6">
      <h2>Your Department-wise Performance Chart</h2>
      <%= pie_chart @department_performance_hash %>
    </div>
  </div>
</div>
